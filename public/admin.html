<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Story Engine – Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; background:#0f172a; color:#fff; display:flex; align-items:center; gap:12px; }
    header input { padding:8px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; }
    header button { padding:8px 12px; border-radius:8px; border:0; background:#22c55e; color:#0b1220; cursor:pointer; }
    main { padding:16px; display:grid; gap:16px; grid-template-columns: 320px 1fr; }
    section { background:#0b1220; color:#e2e8f0; border:1px solid #1e293b; border-radius:12px; padding:12px; }
    h2 { margin:0 0 8px; font-size:16px; color:#93c5fd; }
    label { display:block; margin:8px 0 4px; font-size:13px; color:#a5b4fc; }
    input, textarea, select { width:100%; padding:8px; border-radius:8px; border:1px solid #334155; background:#0f172a; color:#e2e8f0; }
    textarea { min-height:84px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .btn { margin-top:8px; padding:8px 10px; border-radius:8px; border:0; background:#3b82f6; color:#0b1220; cursor:pointer; }
    .btn.red { background:#ef4444; color:#fff; }
    .btn.gray { background:#475569; color:#e2e8f0; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #1e293b; padding:6px 8px; font-size:13px; }
    .muted { color:#94a3b8; }
    .pill { display:inline-block; padding:2px 6px; border-radius:999px; background:#1f2937; font-size:12px; color:#cbd5e1; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; }
    footer { padding:10px 16px; color:#64748b; font-size:12px; }
  </style>
  <!-- D3 + Dagre-D3 für Graph-Layout (LR) -->
<script src="https://unpkg.com/d3@5.16.0/dist/d3.min.js"></script>
<script src="https://unpkg.com/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>

</head>
<body>
<header>
  <strong>Story Engine – Admin</strong>
  <span class="muted">|</span>
  <label style="margin:0">API Key</label>
  <input id="apiKey" placeholder="x-api-key" />
  <button id="saveKey">Speichern</button>
  <span class="muted" id="baseUrlInfo"></span>
</header>

<main>
  <section>
    <h2>Sitzung</h2>
    <label>Session-ID</label>
    <div class="row">
      <input id="sessionId" placeholder="z. B. 13" />
      <button class="btn gray" id="btnNewSession">Neue Session</button>
    </div>

    <div class="grid2">
      <div>
        <h2 style="margin-top:12px">Start setzen</h2>
        <label>Titel</label>
        <input id="startTitle" placeholder="Start" />
        <label>Content (JSON)</label>
        <textarea id="startContent">{ "text": "Das Abenteuer beginnt hier." }</textarea>
        <button class="btn" id="btnStart">/sessions/:id/start</button>
      </div>

      <div>
        <h2 style="margin-top:12px">Option hinzufügen</h2>
        <label>Label</label>
        <input id="optLabel" placeholder="Gehe nach Norden" />
        <label>Ziel-Node</label>
        <select id="optTargetMode">
          <option value="new">Neuen Node anlegen</option>
          <option value="existing">Existierenden Node nutzen</option>
        </select>
        <div id="targetNew">
          <label>Neuer Node: Titel</label>
          <input id="optNodeTitle" placeholder="Am Flussufer" />
          <label>Neuer Node: Content (JSON)</label>
          <textarea id="optNodeContent">{ "text": "Kalter Wind ..." }</textarea>
        </div>
        <div id="targetExisting" style="display:none">
          <label>toNodeId (existiert bereits)</label>
          <input id="optToNodeId" placeholder="z. B. 32" />
        </div>
        <button class="btn" id="btnAddOption">/sessions/:id/add-option</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <h2>Decision & Rewind</h2>
      <div class="row">
        <input id="edgeId" placeholder="edgeId zum Ausführen" />
        <button class="btn" id="btnDecide">/sessions/:id/decision</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="rewindSteps" placeholder="Anzahl Schritte zurück (z. B. 1)" />
        <button class="btn red" id="btnRewind">/sessions/:id/rewind</button>
      </div>
    </div>

    <!-- Snapshots -->
<div style="margin-top:12px">
  <h2>Snapshots</h2>
  <div class="row">
    <input id="snapLabel" placeholder="Label (optional, z. B. 'Vor der Tür')" />
    <button class="btn" id="btnMakeSnap">POST /sessions/:id/snapshot</button>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn gray" id="btnListSnaps">GET /sessions/:id/snapshots</button>
    <input id="snapId" placeholder="snapId" />
    <button class="btn" id="btnRestoreSnap">POST /sessions/:id/restore/:snapId</button>
    <button class="btn red" id="btnDeleteSnap">DELETE /sessions/:id/snapshots/:snapId</button>
  </div>
</div>


    <div style="margin-top:12px">
      <h2>Edges bearbeiten/löschen</h2>
      <div class="grid3">
        <div>
          <label>edgeId</label>
          <input id="editEdgeId" placeholder="z. B. 24" />
        </div>
        <div>
          <label>Neues Label</label>
          <input id="editLabel" placeholder="Neues Label..." />
        </div>
        <div>
          <label>Neues toNodeId</label>
          <input id="editToNodeId" placeholder="z. B. 32" />
        </div>
      </div>
      <label>Condition (JSON)</label>
      <textarea id="editCondition">{}</textarea>
      <label>Effect (JSON)</label>
      <textarea id="editEffect">{}</textarea>
      <div class="row">
        <button class="btn" id="btnPatchEdge">PATCH /edges/:edgeId</button>
        <button class="btn red" id="btnDeleteEdge">DELETE /edges/:edgeId</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <h2>Admin</h2>
      <div class="row">
  <button class="btn gray" id="btnListNodes">GET /admin/nodes</button>
  <button class="btn" id="btnResetSeed">POST /admin/reset (mit Seed)</button>
  <button class="btn red" id="btnResetNoSeed">POST /admin/reset (ohne Seed)</button>
  <button class="btn red" id="btnClear" title="Nur wenn /admin/clear existiert">POST /admin/clear</button>
</div>

    </div>
  </section>

  <section>
    <h2>Session Status</h2>
    <div class="row">
      <button class="btn" id="btnLoadSession">GET /sessions/:id</button>
      <button class="btn" id="btnHistory">GET /sessions/:id/history</button>
    </div>
    <div id="status" class="mono" style="margin-top:8px"></div>

    <h2 style="margin-top:16px">Nodes</h2>
    <div id="nodes" class="mono"></div>

    <h2 style="margin-top:16px">Snapshots</h2>
    <div id="snaps" class="mono"></div>

    <h2 style="margin-top:16px">State</h2>
<textarea id="stateEditor" class="mono" style="width:100%;min-height:120px">{}</textarea>
<div class="row" style="margin-top:6px">
  <button class="btn" id="btnStateRefresh">State neu laden</button>
  <button class="btn" id="btnStateApply">State patchen</button>
</div>

<h2 style="margin-top:16px">Graph (Session)</h2>
<div class="row">
  <button class="btn gray" id="btnGraphVisited">Graph: visited</button>
  <button class="btn gray" id="btnGraphAll">Graph: all</button>
</div>
<svg id="graphSvg" width="100%" height="420" style="background:#0b1220;border:1px solid #1e293b;border-radius:12px;margin-top:8px"></svg>


  </section>
</main>

<footer>Admin-UI · spricht mit deiner API unter <span id="baseUrlFoot"></span></footer>

<script>
  const BASE_URL = "https://live-story-teller-gu7wv.ondigitalocean.app";
  const els = {
    apiKey: document.getElementById("apiKey"),
    saveKey: document.getElementById("saveKey"),
    baseUrlInfo: document.getElementById("baseUrlInfo"),
    baseUrlFoot: document.getElementById("baseUrlFoot"),
    sessionId: document.getElementById("sessionId"),
    btnNewSession: document.getElementById("btnNewSession"),
    startTitle: document.getElementById("startTitle"),
    startContent: document.getElementById("startContent"),
    btnStart: document.getElementById("btnStart"),
    optLabel: document.getElementById("optLabel"),
    optTargetMode: document.getElementById("optTargetMode"),
    targetNew: document.getElementById("targetNew"),
    targetExisting: document.getElementById("targetExisting"),
    optNodeTitle: document.getElementById("optNodeTitle"),
    optNodeContent: document.getElementById("optNodeContent"),
    optToNodeId: document.getElementById("optToNodeId"),
    btnAddOption: document.getElementById("btnAddOption"),
    edgeId: document.getElementById("edgeId"),
    btnDecide: document.getElementById("btnDecide"),
    rewindSteps: document.getElementById("rewindSteps"),
    btnRewind: document.getElementById("btnRewind"),
    editEdgeId: document.getElementById("editEdgeId"),
    editLabel: document.getElementById("editLabel"),
    editToNodeId: document.getElementById("editToNodeId"),
    editCondition: document.getElementById("editCondition"),
    editEffect: document.getElementById("editEffect"),
    btnPatchEdge: document.getElementById("btnPatchEdge"),
    btnDeleteEdge: document.getElementById("btnDeleteEdge"),
    btnListNodes: document.getElementById("btnListNodes"),
    btnReset: document.getElementById("btnReset"),
    btnLoadSession: document.getElementById("btnLoadSession"),
    btnHistory: document.getElementById("btnHistory"),
    status: document.getElementById("status"),
    nodes: document.getElementById("nodes"),
    snapLabel: document.getElementById("snapLabel"),
    btnMakeSnap: document.getElementById("btnMakeSnap"),
    btnListSnaps: document.getElementById("btnListSnaps"),
    snapId: document.getElementById("snapId"),
    btnRestoreSnap: document.getElementById("btnRestoreSnap"),
    btnDeleteSnap: document.getElementById("btnDeleteSnap"),
    snaps: document.getElementById("snaps"),
    stateEditor: document.getElementById("stateEditor"),
    btnStateRefresh: document.getElementById("btnStateRefresh"),
    btnStateApply: document.getElementById("btnStateApply"),
    btnGraphVisited: document.getElementById("btnGraphVisited"),
    btnGraphAll: document.getElementById("btnGraphAll"),
    graphSvg: document.getElementById("graphSvg"),
    btnResetSeed: document.getElementById("btnResetSeed"),
    btnResetNoSeed: document.getElementById("btnResetNoSeed"),
    btnClear: document.getElementById("btnClear")



  };

  let currentGraphMode = "visited";


  // Persistenter Key
  els.apiKey.value = localStorage.getItem("xApiKey") || "dev-secret-change-me";
  els.saveKey.onclick = () => {
    localStorage.setItem("xApiKey", els.apiKey.value || "");
    alert("API-Key gespeichert.");
  };
  els.baseUrlInfo.textContent = BASE_URL;
  els.baseUrlFoot.textContent = BASE_URL;

  // Toggle Target Mode
  els.optTargetMode.onchange = () => {
    const mode = els.optTargetMode.value;
    els.targetNew.style.display = mode === "new" ? "block" : "none";
    els.targetExisting.style.display = mode === "existing" ? "block" : "none";
  };

  function headers() {
    const h = { "Content-Type": "application/json" };
    const key = els.apiKey.value.trim();
    if (key) h["x-api-key"] = key;
    return h;
  }
  async function api(path, init) {
    const res = await fetch(BASE_URL + path, init);
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
    if (!res.ok) throw data || { error: "http_error", status: res.status };
    return data;
  }
  function showStatus(obj) {
    els.status.textContent = JSON.stringify(obj, null, 2);
  }
  function showNodes(obj) {
    els.nodes.textContent = JSON.stringify(obj, null, 2);
  }
  
function showSnaps(obj) {
  els.snaps.textContent = JSON.stringify(obj, null, 2);
}

  // Session anlegen
  els.btnNewSession.onclick = async () => {
    try {
      const body = { startNodeId: null };
      const r = await api("/sessions", { method:"POST", headers: headers(), body: JSON.stringify(body) });
      els.sessionId.value = r.id;
      await loadSession();
    } catch (e) { showStatus(e); }
  };

  // Start setzen
  els.btnStart.onclick = async () => {
    try {
      const sid = Number(els.sessionId.value);
      const body = {
        nodeTitle: els.startTitle.value || "Start",
        nodeContent: safeJSON(els.startContent.value, { text: "Start..." })
      };
      const r = await api(`/sessions/${sid}/start`, { method:"POST", headers: headers(), body: JSON.stringify(body) });
      await loadSession();
    } catch (e) { showStatus(e); }
  };

  // Option hinzufügen
  els.btnAddOption.onclick = async () => {
    try {
      const sid = Number(els.sessionId.value);
      const mode = els.optTargetMode.value;
      const label = (els.optLabel.value || "").trim();
      if (!label) return alert("Label fehlt.");

      let body;
      if (mode === "new") {
        body = {
          label,
          nodeTitle: els.optNodeTitle.value || "Neuer Knoten",
          nodeContent: safeJSON(els.optNodeContent.value, { text: "" })
        };
        await api(`/sessions/${sid}/add-option`, { method:"POST", headers: headers(), body: JSON.stringify(body) });
      } else {
        const toNodeId = Number(els.optToNodeId.value);
        if (!Number.isFinite(toNodeId)) return alert("toNodeId ist ungültig.");
        // Wir nutzen expand mit toNodeId
        body = { edges: [{ label, toNodeId }] };
        await api(`/sessions/${sid}/expand`, { method:"POST", headers: headers(), body: JSON.stringify(body) });
      }
      await loadSession();
    } catch (e) { showStatus(e); }
  };

  // Entscheidung ausführen
  els.btnDecide.onclick = async () => {
    try {
      const sid = Number(els.sessionId.value);
      const edgeId = Number(els.edgeId.value);
      if (!Number.isFinite(edgeId)) return alert("edgeId fehlt/ungültig.");
      const body = { edgeId };
      await api(`/sessions/${sid}/decision`, { method:"POST", headers: headers(), body: JSON.stringify(body) });
      await loadSession();
    } catch (e) { showStatus(e); }
  };

  // Rewind
  els.btnRewind.onclick = async () => {
    try {
      const sid = Number(els.sessionId.value);
      const steps = Number(els.rewindSteps.value || "1");
      const body = { steps };
      const r = await api(`/sessions/${sid}/rewind`, { method:"POST", headers: headers(), body: JSON.stringify(body) });
      await loadSession();
    } catch (e) { showStatus(e); }
  };

// Snapshot anlegen
els.btnMakeSnap.onclick = async () => {
  const sid = Number(els.sessionId.value);
  if (!Number.isFinite(sid)) return alert("Session-ID fehlt/ungültig.");
  const label = (els.snapLabel.value || "").trim();
  const body = label ? { label } : {};
  try {
    const r = await api(`/sessions/${sid}/snapshot`, {
      method: "POST", headers: headers(), body: JSON.stringify(body)
    });
    await listSnaps(); // direkt aktualisieren
  } catch (e) { showStatus(e); }
};

// Snapshots auflisten
async function listSnaps() {
  const sid = Number(els.sessionId.value);
  if (!Number.isFinite(sid)) return alert("Session-ID fehlt/ungültig.");
  try {
    const r = await api(`/sessions/${sid}/snapshots`, { headers: headers() });
    showSnaps(r);
    // Bequemlichkeit: neueste snapId vorbefüllen
    if (Array.isArray(r.snapshots) && r.snapshots.length) {
      els.snapId.value = r.snapshots[0].id;
    }
  } catch (e) { showSnaps(e); }
}
els.btnListSnaps.onclick = listSnaps;

// Snapshot wiederherstellen
els.btnRestoreSnap.onclick = async () => {
  const sid = Number(els.sessionId.value);
  const snapId = Number(els.snapId.value);
  if (!Number.isFinite(sid) || !Number.isFinite(snapId)) return alert("IDs prüfen.");
  try {
    const body = { clearHistory: false }; // bei Bedarf true
    const r = await api(`/sessions/${sid}/restore/${snapId}`, {
      method: "POST", headers: headers(), body: JSON.stringify(body)
    });
    await loadSession();
    await listSnaps();
  } catch (e) { showStatus(e); }
};

// Snapshot löschen
els.btnDeleteSnap.onclick = async () => {
  const sid = Number(els.sessionId.value);
  const snapId = Number(els.snapId.value);
  if (!Number.isFinite(sid) || !Number.isFinite(snapId)) return alert("IDs prüfen.");
  try {
    await api(`/sessions/${sid}/snapshots/${snapId}`, { method: "DELETE", headers: headers() });
    await listSnaps();
  } catch (e) { showSnaps(e); }
};

  
  // Edge patch
  els.btnPatchEdge.onclick = async () => {
    try {
      const edgeId = Number(els.editEdgeId.value);
      if (!Number.isFinite(edgeId)) return alert("edgeId fehlt/ungültig.");

      const body = {};
      if (els.editLabel.value.trim()) body.label = els.editLabel.value.trim();
      if (els.editToNodeId.value.trim()) {
        const n = Number(els.editToNodeId.value.trim());
        if (!Number.isFinite(n)) return alert("toNodeId ungültig.");
        body.toNodeId = n;
      }
      const condTxt = els.editCondition.value.trim();
      if (condTxt) body.condition = safeJSON(condTxt, {});
      const effTxt = els.editEffect.value.trim();
      if (effTxt) body.effect = safeJSON(effTxt, {});
      await api(`/edges/${edgeId}`, { method:"PATCH", headers: headers(), body: JSON.stringify(body) });
      await loadSession();
    } catch (e) { showStatus(e); }
  };

  // Edge delete
  els.btnDeleteEdge.onclick = async () => {
    try {
      const edgeId = Number(els.editEdgeId.value);
      if (!Number.isFinite(edgeId)) return alert("edgeId fehlt/ungültig.");
      await api(`/edges/${edgeId}`, { method:"DELETE", headers: headers() });
      await loadSession();
    } catch (e) { showStatus(e); }
  };

  // Admin
  els.btnListNodes.onclick = async () => {
    try {
      const r = await api(`/admin/nodes`, { headers: headers() });
      showNodes(r);
    } catch (e) { showNodes(e); }
  };
  els.btnReset.onclick = async () => {
    try {
      const r = await api(`/admin/reset`, { method:"POST", headers: headers() });
      showNodes(r);
      els.sessionId.value = "";
      els.status.textContent = "Reset done.";
    } catch (e) { showNodes(e); }
  };

  // Reset mit Seed
els.btnResetSeed.onclick = async () => {
  try {
    const r = await api(`/admin/reset`, {
      method: "POST",
      headers: headers(),
      body: JSON.stringify({ seed: true })
    });
    showNodes(r);
    els.sessionId.value = "";
    els.status.textContent = "Reset (mit Seed) done.";
    els.stateEditor.value = "{}";
  } catch (e) { showNodes(e); }
};

// Reset ohne Seed (leer)
els.btnResetNoSeed.onclick = async () => {
  try {
    const r = await api(`/admin/reset`, {
      method: "POST",
      headers: headers(),
      body: JSON.stringify({ seed: false })
    });
    showNodes(r);
    els.sessionId.value = "";
    els.status.textContent = "Reset (ohne Seed) done.";
    els.stateEditor.value = "{}";
    
    currentGraphMode = "visited";

  } catch (e) { showNodes(e); }
};

// Nur leeren (falls Endpoint existiert)
els.btnClear.onclick = async () => {
  try {
    const r = await api(`/admin/clear`, { method: "POST", headers: headers() });
    showNodes(r);
    els.sessionId.value = "";
    els.status.textContent = "Clear done.";
    els.stateEditor.value = "{}";
  } catch (e) { showNodes(e); }
};


  // Loader
  els.btnLoadSession.onclick = loadSession;
  async function loadSession() {
    const sid = Number(els.sessionId.value);
    if (!Number.isFinite(sid)) return alert("Session-ID fehlt/ungültig.");
    const r = await api(`/sessions/${sid}`, { headers: headers() });
   showStatus(r);
els.stateEditor.value = JSON.stringify(r.state || {}, null, 2);
if (Array.isArray(r.options) && r.options.length) els.edgeId.value = r.options[0].id;
// Optional: Graph direkt anzeigen (visited)
// vorher: loadGraph("visited");
loadGraph(currentGraphMode);


await listSnaps(); // Snapshots parallel anzeigen

  }
  // History laden
els.btnHistory.onclick = async () => {
  const sid = Number(els.sessionId.value);
  if (!Number.isFinite(sid)) return alert("Session-ID fehlt/ungültig.");
  try {
    const r = await api(`/sessions/${sid}/history`, { headers: headers() });
    showStatus(r);
  } catch (e) {
    showStatus(e);
  }
};
  // State neu laden (aus GET /sessions/:id)
els.btnStateRefresh.onclick = async () => {
  const sid = Number(els.sessionId.value);
  if (!Number.isFinite(sid)) return alert("Session-ID fehlt/ungültig.");
  try {
    const r = await api(`/sessions/${sid}`, { headers: headers() });
    els.stateEditor.value = JSON.stringify(r.state || {}, null, 2);
    showStatus(r);
  } catch (e) { showStatus(e); }
};

// State patchen (PATCH /sessions/:id/state)
els.btnStateApply.onclick = async () => {
  const sid = Number(els.sessionId.value);
  if (!Number.isFinite(sid)) return alert("Session-ID fehlt/ungültig.");
  let body = {};
  try { body = JSON.parse(els.stateEditor.value || "{}"); } catch { return alert("Ungültiges JSON."); }
  try {
    const r = await api(`/sessions/${sid}/state`, {
      method: "PATCH", headers: headers(), body: JSON.stringify(body)
    });
    els.stateEditor.value = JSON.stringify(r.state || {}, null, 2);
    await loadSession();
  } catch (e) { showStatus(e); }
};

  async function loadGraph(mode) {
  const sid = Number(els.sessionId.value);
  if (!Number.isFinite(sid)) return alert("Session-ID fehlt/ungültig.");
  try {
    const data = await api(`/sessions/${sid}/graph?mode=${mode}`, { headers: headers() });
    renderGraph(data);
  } catch (e) { showStatus(e); }
}
els.btnGraphVisited.onclick = () => { currentGraphMode = "visited"; loadGraph(currentGraphMode); };
els.btnGraphAll.onclick     = () => { currentGraphMode = "all";     loadGraph(currentGraphMode); };


function renderGraph(payload) {
  const { nodes = [], edges = [], currentNodeId = null, visitedNodeIds = [] } = payload;
  const visitedSet = new Set(Array.isArray(visitedNodeIds) ? visitedNodeIds : []);

  const g = new dagreD3.graphlib.Graph().setGraph({ rankdir: "LR", nodesep: 30, ranksep: 60 });

  nodes.forEach(n => {
    // Farbwahl
    let fill = "#0f172a";  // default
    let stroke = "#334155";
    if (n.id === currentNodeId) { fill = "#22c55e"; stroke = "#14532d"; }         // aktueller Knoten: grün
    else if (visitedSet.has(n.id)) { fill = "#2563eb"; stroke = "#1e3a8a"; }      // besucht: blau

    const label = `${n.id}\n${n.title || ""}`;
    g.setNode(String(n.id), {
      label,
      rx: 8, ry: 8,
      style: `fill:${fill};stroke:${stroke};color:#0b1220`,
      labelStyle: "fill:#e2e8f0"
    });
  });

  edges.forEach(e => {
    const edgeText = `[${e.id}] ${e.label || ""}`; // ID vor dem Namen
    g.setEdge(String(e.from_node_id), String(e.to_node_id), {
      label: edgeText,
      lineInterpolate: "basis",
      style: "stroke:#475569;fill:none",
      arrowheadStyle: "fill:#475569",
      labelStyle: "fill:#cbd5e1;font-size:12px"
    });
  });

  const svg = d3.select(els.graphSvg);
  svg.selectAll("*").remove();
  const inner = svg.append("g");
  const render = new dagreD3.render();
  render(inner, g);

  // Auto-Zoom/Center
  const graphDims = g.graph();
  const width = graphDims.width || 1;
  const height = graphDims.height || 1;
  const svgWidth = els.graphSvg.clientWidth || 800;
  const svgHeight = els.graphSvg.clientHeight || 420;
  const scale = Math.min((svgWidth - 40) / width, (svgHeight - 40) / height, 1.2);
  const x = (svgWidth - (width * scale)) / 2;
  const y = (svgHeight - (height * scale)) / 2;
  inner.attr("transform", `translate(${x},${y}) scale(${scale})`);
}


  


  function safeJSON(text, fallback) {
    try { return JSON.parse(text); } catch { return fallback; }
  }
</script>
</body>
</html>
